#########################################
## This Walkthrough generates count files
## using bowtie2 mapping tool from fastq 
## files reconstructed from bam in order
## to run differential transcription analysis



# This perl script generates a launcher toreconstruct fastq files from .bam files using samtools view and awk scripts

module load samtools
RNAseq_bam2fastq_launch.pl "\.sorted.bam$" "'BEGIN {FS=\"\t\"} {print \"@\" $1 \"\n\" $10 \"\n+\n\" $11}'" > bam2fastq
nano bam2fastq

launcher_creator.py -j  bam2fastq -n  bam2fastq -l bam2fastqj  -q normal -t 12:00:00 -a project -e email
cat bam2fastqj  | perl -pe 's/12way \d+/4way 300/' > bam2fastq.job
qsub bam2fastq.job


################################
#------------------------------
# Quality check!!!! 


module load fastqc
mkdir fastqc_bam
echo 'fastqc --outdir fastqc_bam *fastq ' > qual
launcher_creator.py -j qual -n qual -l qual.job -q normal -t 12:00:00 -a project -e email
qsub qual.job


################################################
################################################
# Building a Reference transcriptome for Bowtie2

#For partially but fully represented transcriptome ~80K genes many unknown genes
module load bowtie/2.1.0
echo 'bowtie2-build MochFull_ref.fasta MochFull_ref' >btb
launcher_creator.py -j btb -n btb -l btbl -a project -e email
qsub btbl

#For fully annotated transcriptome ~29K genes
module load bowtie/2.1.0
echo 'bowtie2-build MochFull_ref_hits.fasta MochFull_ref_hits.fasta' >btb2
launcher_creator.py -j btb2 -n btb2 -l btb2l -a project -e email
qsub btb2l


################################################
################################################
# Mapping reads on the transcriptome using Bowtie2

# iRNAseq_bowtie2map.pl is a launchermaker script 
# written by Dr Misha Matz, available at https://github.com/z0on



#For fully annotated transcriptome ~29K genes
iRNAseq_bowtie2map.pl "fastq$" ref/MochFull_ref_hits.fasta> maps
launcher_creator.py -j  maps -n  maps -l mapsj  -q normal -t 12:00:00 -a project -e email
cat mapsj  | perl -pe 's/12way \d+/4way 300/' > maps.job
qsub maps.job

#For partially but fully represented transcriptome ~80K genes
module load bowtie/2.1.0
iRNAseq_bowtie2map.pl "fastq$" ref/MochFull_ref > maps
nano maps
launcher_creator.py -j  maps -n  maps -l mapsj  -q normal -t 12:00:00 -a project -e email
cat mapsj  | perl -pe 's/12way \d+/4way 300/' > maps.job
qsub maps.job

# To make this analysis easier I changed the names of these libraries using MO for Microtus ochrogaster and MP for Microtus pennsylvanicus


ls 5*.sam | perl -pe 's/^(\S+)\.sam$/cp $1\.sam MO$1\.sam/' > s2b
ls 4*.sam | perl -pe 's/^(\S+)\.sam$/cp $1\.sam MO$1\.sam/' >> s2b
ls 1576*.sam | perl -pe 's/^(\S+)\.sam$/cp $1\.sam MO$1\.sam/' >> s2b
ls 1577*.sam | perl -pe 's/^(\S+)\.sam$/cp $1\.sam MO$1\.sam/' >> s2b
launcher_creator.py -j s2b -n s2b -l s2bjob -q normal -t 12:00:00 -a project -e email
cat s2bjob | perl -pe 's/12way \d+/1way 24/' > s2b.job
qsub s2b.job

ls 1*.sam | perl -pe 's/^(\S+)\.sam$/cp $1\.sam MP$1\.sam/' > s2b3
# delete 1576 and 1577 sam files from this launcher
launcher_creator.py -j s2b3 -n s2b3 -l s2b3job -q normal -t 12:00:00 -a project -e email
cat s2b3job | perl -pe 's/12way \d+/1way 24/' > s2b3.job
qsub s2b3.job


# In order to extract counts from each mapped library, I use samcount.pl
# this needs a lot of TACC memory

ls MO*.sam | perl -pe 's/^(\S+)\.sam$/samcount.pl $1\.sam ref\/MochFullome_iso_seq2iso.tab aligner=bowtie2 >$1\.counts/' > MOcounts
ls MP*.sam | perl -pe 's/^(\S+)\.sam$/samcount.pl $1\.sam ref\/MochFullome_iso_seq2iso.tab aligner=bowtie2 >$1\.counts/' > MPcounts

launcher_creator.py -j  MOcounts -n MOcounts -l MOcountsj  -q largemem -t 24:00:00 -a project -e email
cat MOcountsj  | perl -pe 's/12way \d+/1way 24/' > MOcounts.job
qsub MOcounts.job

launcher_creator.py -j  MPcounts -n MPcounts -l MPcountsj  -q largemem -t 24:00:00 -a project -e email
cat MPcountsj  | perl -pe 's/12way \d+/1way 24/' > MPcounts.job
qsub MPcounts.job

# In order to compile counts to a single file to use as an input for DEseq2, I use expression_compiler.pl

expression_compiler.pl M*.sam.counts > allcounts.txt
cat allcounts.txt | grep -E 'iso' | wc -l


#### download allcounts.txt to your computer to run DEseq2
#### Happy DEseqing!!!!






